{% extends 'base.html' %}
{% load static %}

{% block title %}{{ slide.name }}{% endblock %}

{% block extra_head %}
    <!-- Openseadragon -->
    <script src="{% static 'openseadragon/openseadragon.min.js' %}"></script>
    <!-- Openseadragon scalebar ÌîåÎü¨Í∑∏Ïù∏ -->
    <script src="{% static 'openseadragon/openseadragon-scalebar.js' %}"></script>
    <!-- annotorious JS -->
    <script src="{% static 'annotorious/js/annotorious-openseadragon.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/@annotorious/plugin-tools@1.0.2/dist/annotorious-plugin-tools.js"></script>
    <!-- OSDMeasure ÌîåÎü¨Í∑∏Ïù∏ -->
    <script src="{% static 'OSDMeasure/dexie.min.js' %}"></script>
    <script src="{% static 'OSDMeasure/fabricjs.min.js' %}"></script>
    <script src="{% static 'OSDMeasure/openseadragon-fabricjs-overlay.js' %}"></script>
    <script src="{% static 'OSDMeasure/OSDMeasure.js' %}"></script>
    <!-- screenshot ÌîåÎü¨Í∑∏Ïù∏ -->
    <script src="{% static 'screenshot/html2canvas.min.js' %}"></script>

{% endblock extra_head %}


<!-- css -->
{% block extra_css %}
    <!-- custom slide-viewer css -->
    <link rel="stylesheet" href="{% static 'slide_viewer/css/viewer.css' %}">
    <!-- annotorious CSS -->
    <link rel="stylesheet" href="{% static 'annotorious/css/annotorious-openseadragon.css' %}">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@annotorious/plugin-tools@1.0.2/dist/annotorious-plugin-tools.css">
{% endblock extra_css %}

<!-- slide_name part in header block -->
{% block slide_name %}
    {{ slide.name }}
{% endblock slide_name %}


<!-- main block -->
{% block content %}
    <div id="openseadragon-container"></div>
{% endblock content %}

<!-- nav block -->
{% block nav_content %}
    <!-- ÌôîÎ©¥ ÌÅ¥ Îïå ÎÇòÏò§Îäî ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark custom-nav nav-large-query">
        <div class="container-fluid custom-nav">
            <!-- Ï†ÑÏ≤¥ Î≤ÑÌäº Í∑∏Î£π -->
            <div class="btn-group" role="group">
                <!-- File ÎìúÎ°≠Îã§Ïö¥ Î≤ÑÌäº -->
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop_file" type="button"
                            class="btn btn btn-outline-light custom-button dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-expanded="false" title="File"> File
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="btnGroupDrop_file">
                        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
                        <li>
                            {% if can_edit_annotation %}
                                <button class="dropdown-item" id="annotation-update-btn" title="Save"
                                        data-annotation-id="{{ annotation.id }}"
                                        data-url="{% url 'api:annotation-detail' pk=annotation.id %}">
                                    <i class="bi bi-floppy"></i> Save
                                </button>
                            {% endif %}
                            {% if can_create_annotation %}
                                <button class="dropdown-item" title="Save As" data-bs-toggle="modal"
                                        data-bs-target="#annotation-create-modal">
                                    <i class="bi bi-floppy"></i> Save As..
                                </button>
                            
                        </li>
                        <li>
                            <hr class="dropdown-divider" style="--bs-dropdown-divider-margin-y: 0">
                        </li>
                        {% endif %}
                        <!-- Ï†ïÎ≥¥ Î≤ÑÌäº -->
                        <li>
                            <button class="dropdown-item" title="Slide-Information" onclick="openinfoPopup()">
                                <i class="bi bi-info-circle"></i> Information
                            </button>
                        </li>
                        <!-- ÎèÑÏõÄÎßê Î≤ÑÌäº -->
                        <li>
                            <button class="dropdown-item" title="Help">
                                <i class="bi bi-question-circle"></i> Help
                            </button>
                        </li>
                    </ul>
                </div>
                <!-- View ÎìúÎ°≠Îã§Ïö¥ Î≤ÑÌäº -->
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop_view" type="button"
                            class="btn btn btn-outline-light custom-button dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-expanded="false" title="File"> View
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="btnGroupDrop_view">
                        <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÌÑ∞ Î≤ÑÌäº-->
                        <li>
                            <button class="dropdown-item" onclick="toggleNav()" title="Toggle Navigator">
                                <i class="bi bi-geo-alt-fill"></i> Navigator
                            </button>
                        </li>
                        <!-- Ï†ÑÏ≤¥ÌôîÎ©¥ Î≤ÑÌäº -->
                        <li>
                            <button class="dropdown-item" onclick="toggleFullScreen()" title="Full Screen">
                                <i class="bi bi-arrows-fullscreen"></i> Full Screen
                            </button>
                        </li>
                        <!-- Brightness Control -->
                        <li class="dropdown-item">
                            <label for="brightness">Î∞ùÍ∏∞:</label>

                            <input type="range" id="brightness" min="0" max="2" step="0.01" value="1"
                                   oninput="updateFilters()">
                            <span id="brightness-value" class="filter-value">1.00</span>

                            <button type="button" onclick="resetBrightness()">Reset</button>
                        </li>
                        <!-- Contrast Control -->
                        <li class="dropdown-item">
                            <label for="contrast">ÎåÄÎπÑ:</label>
                            <input type="range" id="contrast" min="0" max="2" step="0.01" value="1"
                                   oninput="updateFilters()">
                            <span id="contrast-value" class="filter-value">1.00</span>
                            <button type="button" onclick="resetContrast()">Reset</button>
                        </li>
                        <!-- Saturate Control -->
                        <li class="dropdown-item">
                            <label for="saturate">Ï±ÑÎèÑ:</label>
                            <input type="range" id="saturate" min="0" max="2" step="0.01" value="1"
                                oninput="updateFilters()">
                            <span id="saturate-value" class="filter-value">1.00</span>
                            <button type="button" onclick="resetSaturate()">Reset</button>
                        </li>

                    </ul>
                </div>
                <!-- Î∞∞Ïú® ÎìúÎ°≠Îã§Ïö¥ Î≤ÑÌäº -->
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop_scale" type="button"
                            class="btn btn btn-outline-light custom-button dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-expanded="false" style="width: 102px;" title="Change Lens">
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="btnGroupDrop_scale">
                        <!-- Reset Î≤ÑÌäº -->
                        <li>
                            <button class="dropdown-item" onclick="viewer.viewport.goHome()">
                                Reset
                            </button>
                        </li>
                        <!-- Î∞∞Ïú® Î≤ÑÌäº -->
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(1.25)">1.25X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(2.5)">2.5X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(5)">5X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(10)">10X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(20)">20X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(40)">40X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(63)">63X</button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setZoomLevel(100)">100X</button>
                        </li>
                    </ul>
                </div>
                <!-- Í∑∏Î¶¨Í∏∞ ÎìúÎ°≠Îã§Ïö¥ Î≤ÑÌäº-->
                <div class="btn-group" role="group">
                    <button id="btnGroupDrop_annotation" type="button"
                            class="btn btn btn-outline-light custom-button dropdown-toggle"
                            data-bs-toggle="dropdown"
                            aria-expanded="false" title="Drawing" style="background-color: rgb(243, 88, 83);">
                        <span>Drawing </span><span id="ink">‚óè</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="btnGroupDrop_annotation">
                        <!-- Annotation Î≤ÑÌäº-->
                        <li>
                            <button class="dropdown-item" onclick="setDrawingTool('ellipse')"><i
                                    class="bi bi-circle"></i> Circle
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setDrawingTool('rectangle')"><i
                                    class="bi bi-square"></i> Rectangle
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setDrawingTool('polygon')"><i
                                    class="bi bi-pentagon"></i> Polygon
                            </button>
                        </li>
                        <li>
                            <hr class="dropdown-divider" style="--bs-dropdown-divider-margin-y: 0">
                        </li>
                        <!-- Measure Î≤ÑÌäº-->
                        <li>
                            <button class="dropdown-item" onclick="plugin.setMeasureMode(true)"><i
                                    class="bi bi-rulers"></i> Linear Measure
                            </button>
                        </li>
                        <li>
                            <hr class="dropdown-divider" style="--bs-dropdown-divider-margin-y: 0">
                        </li>
                        <li class="dropdown-item">
                            <i class="bi bi-palette"></i><span> Choose Color </span>
                        </li>
                        <!-- Ìï≠ÏÉÅ Î≥¥Ïù¥Îäî ÏÉâÏÉÅ ÌåîÎ†àÌä∏ -->
                        <li class="color-palette">
                            <div class="color-option" data-color="#ff0000">
                                <div class="color-circle red"></div>
                            </div>
                            <div class="color-option" data-color="#0000ff">
                                <div class="color-circle blue"></div>
                            </div>
                            <div class="color-option" data-color="#000001">
                                <div class="color-circle black"></div>
                            </div>
                            <div class="color-option" data-color="#ffffff">
                                <div class="color-circle white"></div>
                            </div>
                            <div class="color-option" data-color="#ffff00">
                                <div class="color-circle yellow"></div>
                            </div>
                            <div class="color-option" data-color="#ff00ff">
                                <div class="color-circle magenta"></div>
                            </div>
                            <div class="color-option" data-color="#00ff00">
                                <div class="color-circle green"></div>
                            </div>
                            <div class="color-option" data-color="#8b4513">
                                <div class="color-circle brown"></div>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- Ïà®Í∏∞Í∏∞ Î≤ÑÌäº -->
                <button class="btn btn btn-outline-light custom-button" id="invisible-btn"
                        title="Hide Annotation" style="background-color: rgb(243, 88, 83);">
                    <i class="bi bi-eye-slash"></i>
                </button>
                <!-- ÏßÄÏö∞Í∞ú Î≤ÑÌäº -->
                <button class="btn btn btn-outline-light custom-button" id="erase-btn"
                        title="Remove Annotation" style="background-color: rgb(243, 88, 83); display: none;">
                    <i class="bi bi-eraser"></i>
                </button>
                <!-- annotation ÏàòÏ†ï Î≤ÑÌäº -->
                <button class="btn btn btn-outline-light custom-button" id="edit-btn"
                        title="Edit Annotation" style="background-color: rgb(243, 88, 83); display: none;">
                    <i class="bi bi-pen"></i>
                </button>
            </div>
            <!-- Ïò§Î•∏Ï™Ω Î≤ÑÌäº Í∑∏Î£πÎì§ -->
            <div class="btn-group ms-auto nav-media-query" role="group">
                <!-- Reset Î≤ÑÌäº(Ïù¥ Ïù¥ÌõÑÎ°ú Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∞ÄÎ¶ºÎ¶º) -->
                <button class="btn btn btn-outline-light custom-button"
                        onclick="viewer.viewport.goHome(true)" title="Reset View">
                    <i class="bi bi-house"></i>
                </button>
                <!-- Ï†ÄÏû• Î≤ÑÌäº -->
                <button class="btn btn btn-outline-light custom-button" 
                        onclick="captureOpenSeadragonView()" title="Screenshot">
                    <i class="bi bi-camera"></i>
                </button>
            </div>
        </div>
    </nav>
    <!-- ÌôîÎ©¥ ÏûëÏùÑ Îïå ÎÇòÏò§Îäî ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark custom-nav nav-small-query">
        <div class="container-fluid custom-nav nav-slide-text d-flex justify-content-center">
            {{ slide.name }}
        </div>
    </nav>
{% endblock nav_content %}

<!-- aside block -->
{% block aside_content %}

    <div class="text-center flex-grow-1">
        {% if annotation %}
        {{ annotation.name|slice:':20' }}
        {% else %}
        Description
        {% endif %}
    </div>
    <!-- Ïò§Î•∏Ï™Ω Î≤ÑÌäº Í∑∏Î£πÎì§ -->
    <div class="btn-group ms-auto nav-media-query" role="group">
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <button class="btn btn btn-outline-light custom-button" onclick="" title="Save">
            <i class="bi bi-floppy"></i>
        </button>
    </div>

{% endblock aside_content %}

<!-- article block -->
{% block article_content %}
    <div id="article-header">
        <!-- Î≤ÑÌäºÏù¥ Ï∂îÍ∞ÄÎê† Ïª®ÌÖåÏù¥ÎÑà -->
    </div>
    <div id="article-body">
        <!-- Î≤ÑÌäºÏù¥ Ï∂îÍ∞ÄÎê† Ïª®ÌÖåÏù¥ÎÑà -->
    </div>
{% endblock article_content %}

{% block extra_modal %}
    <div class="modal fade" id="annotation-create-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Annotation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="annotation-create-form" data-url="{% url 'api:annotation-list' %}">
                    <div class="modal-body">
                        <input type="hidden" name="slide" value="{{ slide.id }}">
                        <label for="annotation-create-name" class="form-label">Annotation Name</label>
                        <input type="text" class="form-control" id="annotation-create-name" name="name" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock extra_modal %}


{% block extra_js %}


    <!-- slide metadata Î∂àÎü¨Ïò§Í∏∞ -->
    <div id="overlay"></div>

    <!-- ÌåùÏóÖ(Annotation) Ìèº -->
    <div id="annotation-popup">
        <h3>Annotation Details</h3>
        <form id="annotation-form">
            <label for="title">Title:</label><br>
            <input type="text" id="title" name="title" required><br><br>
            <label for="comment">Comment:</label><br>
            <textarea id="comment" name="comment" required></textarea><br><br>
            <button type="submit">Save</button>
            <button type="button" onclick="cancelPopup()">Cancel</button>
        </form>
    </div>

    <!-- ÌåùÏóÖ(Information) -->
    <div id="information-popup" style="display: none;">
        <h3>Information</h3>
        <div id="information-box">
            {{ slide.information }} <!-- Ï†ïÎ≥¥ ÎÇ¥Ïö© ÌëúÏãú -->
        </div>
        <button type="button" onclick="closeinfoPopup()">Close</button>
    </div>


    {{ slide.metadata|json_script:"slide-metadata" }}
    <!-- extensionÏóêÏÑú django Îã§Ïö¥Î∞õÍ∏∞
Ïù¥Îü∞ ÏãùÏúºÎ°ú Î∞õÏïÑÏò§Î©¥ Îèº
 http://127.0.0.1:8000/api/database/slides/ Ïù¥ ÎßÅÌÅ¨Ïùò Í≤ÉÏùÄ {{ slide.name }}Ïù¥ÎÇò {{ slide.information }} Ï≤òÎüº Í∞ÄÏ†∏Ïò§Î©¥ ÎêòÍ≥†

 http://127.0.0.1:8000/api/viewer/annotations/ Ïó¨Í∏∞ÏÑú ÎÇòÏò§Îäî "data"Ïóê annotation jsonÏù¥ Îì§Ïñ¥Í∞ÄÎ©¥ ÎêòÎäîÎç∞, 
 http://127.0.0.1:8000/api/viewer/annotations/data/ Í∑∏Îü¨Î©¥ Ïó¨Í∏∞Ïóê Ï†ÄÏû•Îê† Í±∞Ïïº. Î∂àÎü¨Ïò¨ ÎïåÎäî slideAnnotationÏúºÎ°ú Î∂àÎü¨Ïò§Î©¥ ÎêòÎäî Í±∞ Í∞ôÍ≥†Í≥†
-->

    <!-- script -->
    <script type="text/javascript">
        // ÌòÑÏû¨ Ïó∞Í≤∞Îêú annotation Ï†ïÎ≥¥. `undefined` Î©¥ Ïó∞Í≤∞Îêú annotation Ïù¥ ÏóÜÎã§Í≥† Î≥¥Î©¥ Îê®.
        let annotation;
        {% if annotation %}
            annotation = {
                description: '{% if annotation.description %}{{ annotation.description }}{% endif %}',
                data: {{ annotation.data | safe }},
            };
        {% endif %}

        var viewer = OpenSeadragon({
            id: "openseadragon-container",
            tileSources: "{% url 'api:slide-dzi' pk=slide.id %}",
            prefixUrl: "{% static 'openseadragon/images' %}/",
            //ÎÑ§ÎπÑÍ≤åÏù¥ÌÑ∞
            showNavigator: true,
            navigatorPosition: "BOTTOM_RIGHT", //ÎÑ§ÎπÑÍ≤åÏù¥ÌÑ∞ ÏúÑÏπò
            navigatorSizeRatio: 0.17, //ÎÑ§ÎπÑÍ≤åÏù¥ÌÑ∞ ÌÅ¨Í∏∞Î•º Î∑∞Ïñ¥Ïùò ÏñºÎßà ÎπÑÏú®Î°ú
            navigatorMaintainSizeRatio: true, //Î∑∞Ïñ¥ ÌÅ¨Í∏∞ Î≥ÄÍ≤ΩÎêòÎ©¥ ÎÑ§ÎπÑÍ≤åÏù¥ÌÑ∞ÎèÑ Î∞îÎÄú
            navigatorDisplayRegionColor: "blue", //viewport Íµ¨Ïó≠ ÌëúÏãú ÏÉâ
            navigatorBorderColor: "rgba(0, 0, 0, 0.4)", //ÌÖåÎëêÎ¶¨ ÏÉâÏÉâ
            navigatorBackground: "rgb(248, 249, 250)", //Î∞∞Í≤ΩÏÉâ
            navigatorAutoFade: false,

            debugMode: false,
            //ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïª®Ìä∏Î°§
            showNavigationControl: true,
            navigationControlAnchor: OpenSeadragon.ControlAnchor.TOP_RIGHT,
            zoomInButton: 'zoom-in',
            zoomOutButton: 'zoom-out',
            homeButton: 'home',
            fullPageButton: 'full-page',
            nextButton: 'next',
            previousButton: 'previous',
            maxZoomLevel: 52, //ÏµúÎåÄ Ï§å Î†àÎ≤® ÏÑ§Ï†ï. 100XÍπåÏßÄ ÎêòÎèÑÎ°ù ÏÑ§Ï†ïÌï®.
            showRotationControl: true,
            gestureSettingsMouse: {
                clickToZoom: false, //ÏÇ¨Ïö©Ïãú ÏïΩÍ∞Ñ Î∂àÌé∏Ìï¥ÏÑú Í∫ºÎë† (250210)
                dblClickToZoom: true,
                pinchToZoom: true,
                scrollToZoom: true,
                pinchRotate: true
            }
            
        });

        const raw_metadata = JSON.parse(document.getElementById('slide-metadata').textContent);
        const slide_metadata = {
            mpp_x: parseFloat(raw_metadata["mpp-x"]).toFixed(3), // toFixed(3)Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏÜåÏàòÏ†ê 3ÏûêÎ¶¨ Î¨∏ÏûêÏó¥Î°ú ÎßåÎì§ ÏàòÎèÑ ÏûàÏùå
            sourceLens: parseInt(raw_metadata.sourceLens)
        };

        //Scalebar Ï∂îÍ∞Ä
        viewer.scalebar({
            type: OpenSeadragon.ScalebarType.MICROSCOPY,
            pixelsPerMeter: 1 / slide_metadata.mpp_x * 1000000,
            minWidth: "150px",
            location: OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,
            color: "black",
            fontColor: "black",
            backgroundColor: "rgba(255, 255, 255, 0.5)",
            fontSize: "large",
            barThickness: 3,
        });
        var navShown = true;

        function toggleNav() {
            if (navShown) {
                viewer.navigator.element.style.display = "none";
            } else {
                viewer.navigator.element.style.display = "inline-block";
            }
            navShown = !navShown;
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.getElementById('openseadragon-container').requestFullscreen()
                    .catch(err => {
                        console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
            } else {
                document.exitFullscreen();
            }
        }

        // Add touch gesture support
        let touchStartX = 0;
        let touchStartY = 0;
        document.getElementById('openseadragon-container').addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        // Scale
        //sourceLensÏùò Í∞íÍ≥º baseImageZoomÏùÑ Ïù¥Ïö©ÌïòÏó¨ Î∞∞Ïú® Î≥¥Ï†ïÏ†ï
        function calculateZoomFactor(targetMagnification) {
            const sourceLens = slide_metadata.sourceLens;
            const baseImageZoom = viewer.viewport.viewportToImageZoom(sourceLens);
            const zoomFactor = targetMagnification / baseImageZoom;
            return zoomFactor;
        }

        //zoom ÏÑ§Ï†ïÏ†ï
        function setZoomLevel(targetMagnification) {
            const zoomFactor = calculateZoomFactor(targetMagnification);
            viewer.viewport.zoomTo(zoomFactor, refPoint = null, immeadiately = true);

        }

        let plugin = null;

        // ÏµúÎåÄ zoom level ÏÑ§Ï†ï
        viewer.addHandler("open", function () {

            // 100Î∞∞Ïóê ÌïÑÏöîÌïú zoom factorÎ•º ÎØ∏Î¶¨ Íµ¨Ìï¥Î≥∏ Îí§
            const zoomFactorAt100x = calculateZoomFactor(100);

            // Í∑∏ Í∞íÏùÑ maxZoomLevelÏóê ÏÑ§Ï†ï
            viewer.viewport.maxZoomLevel = zoomFactorAt100x;

            const contentFactor = viewer.world._contentFactor;

            plugin = new OSDMeasure(viewer, {
                conversionFactor: slide_metadata.mpp_x,
                units: "um",
                fontSize: contentFactor / 50,
                selectedColor: selectedColor
            });
        });

        let currentMagnification;
        //ÌòÑÏû¨ zoomÏùÑ Ï∂îÏ†Å, Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function trackZoomAndUpdateButton() {
            const scaleButton = document.getElementById('btnGroupDrop_scale'); // Scale Î≤ÑÌäº ÏÑ†ÌÉù
            if (!scaleButton) {
                console.error('Scale button not found');
                return;
            }

            //Î∞∞Ïú® Î≥ÄÌôî Í∞êÏßÄ, Î≤ÑÌäºÏóê Î∞òÏòÅ
            viewer.addHandler('zoom', function () {
                let viewportZoom = viewer.viewport.getZoom();
                let imageZoom = viewer.viewport.viewportToImageZoom(viewportZoom);
                const sourceLens = slide_metadata.sourceLens;

                currentMagnification = imageZoom * sourceLens;

                const predefinedMagnifications = [5, 10, 20, 40, 63, 100]; // Ï†ïÏàò Î∞∞Ïú® Î¶¨Ïä§Ìä∏
                if (predefinedMagnifications.includes(Math.round(currentMagnification))) {
                    scaleButton.textContent = `${Math.round(currentMagnification)}X`;
                } else {
                    scaleButton.textContent = `${currentMagnification.toFixed(2)}X`;
                }
            })
        }

        //ÌéòÏù¥ÏßÄ Î°úÎìúÎê† Îïå -Î∞∞Ïú® Ï∂îÏ†Å ÏãúÏûë, ÏÉâÏÉÅ ÌåîÎ†àÌä∏ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            // ÏÉâÏÉÅ ÌåîÎ†àÌä∏ Í¥ÄÎ†® Ï¥àÍ∏∞Ìôî
            const colorPalette = document.querySelector('.color-palette');
            const dropdownMenu = document.querySelector('#btnGroupDrop_annotation').nextElementSibling;

            // ÏÉâÏÉÅ ÌåîÎ†àÌä∏ ÏïàÏóêÏÑú ÌÅ¥Î¶≠ Ïãú ÎìúÎ°≠Îã§Ïö¥Ïù¥ Îã´ÌûàÏßÄ ÏïäÎèÑÎ°ù Î∞©ÏßÄ
            colorPalette.addEventListener('click', function (event) {
                event.stopPropagation(); // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Í∞Ä Î∂ÄÎ™® ÏöîÏÜåÍπåÏßÄ Ï†ÑÎã¨ÎêòÏßÄ ÏïäÎèÑÎ°ù ÎßâÏùå
            });

            // Î∞∞Ïú® Ï∂îÏ†Å ÏãúÏûë
            trackZoomAndUpdateButton();
        });


        // Add keyboard controls
        document.addEventListener('keydown', function (event) {

            const activeEl = document.activeElement;
            if (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA') {
                return; // ÏûÖÎ†•Ï∞ΩÏóê Ìè¨Ïª§Ïä§ ÏûàÏùÑ Îïê ÌÇ§ ÎßâÍ∏∞
            }

            switch (event.key) {
                case 'n':
                case 'N':
                    toggleNav(); //ÎÑ§ÎπÑÍ≤åÏù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
                    break;
                case 'f':
                case 'F':
                    toggleFullScreen(); //Ï†ÑÏ≤¥ÌôîÎ©¥
                    break;
                case 'h':
                case 'H':
                case '0':
                    viewer.viewport.goHome(true); //reset view
                    break;
                case 'p':
                    captureOpenSeadragonView();
                    break;
                //case 'r':
                //case 'R':
                //    viewer.viewport.setRotation(90); //90ÎèÑ ÌöåÏ†Ñ : Ï†úÎåÄÎ°ú ÏïàÎê®. Î≥¥Î•ò
                //    break;
                 
               //Ïà´ÏûêÌÇ§ ÏûÖÎ†•Ïãú Î∞∞Ïú® Ï°∞Ï†ïÏ†ï
                case '1':
                    setZoomLevel(1.25);
                    break;
                case '2':
                    setZoomLevel(2.5);
                    break;
                case '3':
                    setZoomLevel(5);
                    break;
                case '4':
                    setZoomLevel(10);
                    break;
                case '5':
                    setZoomLevel(20);
                    break;
                case '6':
                    setZoomLevel(40);
                    break;
                case '7':
                    setZoomLevel(63);
                    break;
                case '8':
                    setZoomLevel(100);
                    break;

                // ÏßÅÏÇ¨Í∞ÅÌòï, ÌÉÄÏõêÌòï Ï£ºÏÑù ÏßÄÏö∞Í∏∞
                //case "Backspace":   //Îß•OS Ïù¥Ïö©Ïûê
                //case "Delete":      //ÏúàÎèÑÏö∞ Ïù¥Ïö©Ïûê
                //    let selectedAnno = anno.getSelected()[0];
                //    if (selectedAnno) {
                //        anno.removeAnnotation(selectedAnno.id);
                //    }
                //    break;
            }
        });


        // viewer.addHandler('update-viewport', function () {
        //     // Viewport Zoom Í∞ÄÏ†∏Ïò§Í∏∞
        //     var viewportZoom = viewer.viewport.getZoom();

        //     // Viewport ZoomÏùÑ Image ZoomÏúºÎ°ú Î≥ÄÌôò
        //     var imageZoom = viewer.viewport.viewportToImageZoom(viewportZoom);

        //     // ÏΩòÏÜîÏóê Ï∂úÎ†•
        //     console.log("Viewport Zoom:", viewportZoom);
        //     console.log("Image Zoom:", imageZoom);
        // });

        OpenSeadragon.setString("Tooltips.ScreenshotToggle", "Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï†ÄÏû•");

        window.getScreenshotFilename = function () {
            function getFormattedTime() {
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                const ss = String(now.getSeconds()).padStart(2, '0');
                return `${yyyy}${mm}${dd}-${hh}${min}${ss}`;
            }

            const userId = "{{ user.username }}";
            const slideTitle = "{{ slide.name|slice:':15' }}".replace(/\s+/g, '_');
            const timeStr = getFormattedTime();
            return `${userId}_${timeStr}_${slideTitle}`;
        };

        //const viewerElement = viewer.element; // ÎòêÎäî document.getElementById('openseadragon-viewer')
        //const offset = OpenSeadragon.getElementOffset(viewerElement);
        //console.log(`Î∑∞Ïñ¥ ÏúÑÏπò: x=${offset.x}, y=${offset.y}`);


        // Annotorious Ï¥àÍ∏∞Ìôî
        let anno;
        let anno2;
        let selectedColor = '#ff0000'
        let editMode = false;
        document.getElementById("ink").style.color = selectedColor;
        anno = AnnotoriousOSD.createOSDAnnotator(viewer, {
            userSelectAction: "{% if can_create_annotation %}EDIT{% else %}NONE{% endif %}"
        });


        {% if can_create_annotation %}
            const activeAnno = anno;
        {% else %}
            anno2 = AnnotoriousOSD.createOSDAnnotator(viewer);
            const activeAnno = anno2;
        {% endif %}

        AnnotoriousTools.mountPlugin(activeAnno);


        const slideId = {{ slide.id }};


        //Ï†ÄÏû•Îêú Ï£ºÏÑù Ïù¥ÎØ∏ÏßÄ Î∞è ÏÑ§Î™Ö(Ïä¨ÎùºÏù¥Îìú ÏûêÏ≤¥ ÏÑ§Î™Ö & Ï£ºÏÑù ÏÑ§Î™Ö) ÎùÑÏö∞Í∏∞ (fetch ÏÇ¨Ïö© Ï†úÍ±∞)
        if (annotation && annotation.data) {
            annotation.data.forEach(annot => {
                anno.addAnnotation(annot);
                updateAnnotationDisplay(annot);
            });

            //Ïä¨ÎùºÏù¥Îìú ÏûêÏ≤¥ ÏÑ§Î™Ö
            const articleHeader = document.getElementById('article-header');
            const descriptionElement = document.createElement('p');
            const formattedDescription = annotation.description.replace(/\n/g, '<br>');
            descriptionElement.innerHTML = formattedDescription;
            descriptionElement.classList.add('annotation-description'); // ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            articleHeader.appendChild(descriptionElement);

        }


        // Í∑∏Î¶¨Í∏∞ Î™®Îìú Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
        function setDrawingTool(tool) {
            if (!activeAnno) return console.error('Annotorious is not initialized');
            activeAnno.setDrawingEnabled(true);
            activeAnno.setDrawingTool(tool);
            viewer.setMouseNavEnabled(false);
            //document.getElementById('openseadragon-viewer').classList.add('cursor-crosshair');
        }

        activeAnno.on('createAnnotation', (annotation) => {
            activeAnno.setDrawingEnabled(false);
            viewer.setMouseNavEnabled(true);
            annotation["motivation"] = selectedColor;
            editMode = false;

            openPopup(annotation)
        });


        //Ï£ºÏÑù ÏÑ†ÌÉù ÌõÑ ÏßÄÏö∞Í∞ú Î≤ÑÌäº ÌÅ¥Î¶≠ÌïòÎ©¥ -> ÏßÄÏö∞Í∏∞
        activeAnno.on('selectionChanged', (annotation) => {
            let deleteBtn = document.getElementById('erase-btn');
            let editBtn = document.getElementById('edit-btn');

            if (annotation[0] != null) { //Ï£ºÏÑùÏù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞
                let selectedAnnotation = annotation[0]; // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ï£ºÏÑù Ï†ÄÏû•
                // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏Î•º ÎçÆÏñ¥Ïì∞Îäî Î∞©ÏãùÏúºÎ°ú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
                deleteBtn.onclick = () => {
                    activeAnno.removeAnnotation(selectedAnnotation.id);

                    // article-headerÏôÄ article-bodyÏóêÏÑú Ìï¥Îãπ annotationÏùò ÏöîÏÜå Ï†úÍ±∞
                    let bodyElem = document.getElementById('annotation-combined-' + selectedAnnotation.id);
                    if (bodyElem) bodyElem.remove();

                };

                // Ìé∏Ïßë Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï - openEditPopup Ìï®Ïàò Ìò∏Ï∂ú
                editBtn.onclick = () => {
                    openEditPopup(selectedAnnotation);
                };

                document.getElementById('erase-btn').style.display = 'block';
                document.getElementById('edit-btn').style.display = 'block';


                console.log(annotation);
            } else { // Ï£ºÏÑù ÏÑ†ÌÉùÏù¥ Ìï¥Ï†úÎêú Í≤ΩÏö∞
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï†úÍ±∞ (nullÎ°ú ÏÑ§Ï†ï)
                deleteBtn.onclick = null;
                document.getElementById('erase-btn').style.display = 'none';
                document.getElementById('edit-btn').style.display = 'none';
            }
        });

        //OSDMeasure ÏÇ≠Ï†ú Î≤ÑÌäº ÎùÑÏö∞Í∏∞
        window.addEventListener('measurement-selected', e => {
            const m = e.detail.measurement;

            // ÏõêÌïòÎäî Ï†ïÎ≥¥ ÎùÑÏö∞Í∏∞
            document.getElementById('erase-btn').style.display = 'block';

            // ÏÇ≠Ï†ú Î≤ÑÌäºÏóê Ìï¥Îãπ Ï∏°Ï†ï Ï†ÄÏû•
            document.getElementById('erase-btn').onclick = () => {
                plugin.deleteSelectedMeasurement(m);
                document.getElementById('erase-btn').style.display = 'none';
            };
        });

        window.addEventListener('measurement-deselected', () => {
            console.log("deselected");
            document.getElementById('erase-btn').style.display = 'none';
        });

        // ÏÉâÏÉÅ ÏÑ†ÌÉù
        document.querySelectorAll('.color-option').forEach(item => {
            item.addEventListener('click', function () {
                selectedColor = this.dataset.color;
                document.getElementById("ink").style.color = selectedColor;

                plugin.setMeasurementColor(selectedColor);
            });
        });

        //annotorious Ï£ºÏÑù ÏÉâ ÏßÄÏ†ï
        anno.setStyle((annotation, state) => {
            const color = annotation["motivation"];
            return {
                fillOpacity: 0,
                stroke: color,
                strokeOpacity: 1,
                strokeWidth: 3
            }
        });
        if(anno2){
            anno2.setStyle((annotation, state) => {
                const color = annotation["motivation"];
                return {
                    fillOpacity: 0,
                    stroke: color,
                    strokeOpacity: 1,
                    strokeWidth: 3
                }
            });
        }

        function openPopup(annotation) {
            return new Promise((resolve, reject) => {
                // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                document.getElementById('title').value = '';
                document.getElementById('comment').value = '';
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('annotation-popup').style.display = 'block';

                const form = document.getElementById('annotation-form');

                // ÌåùÏóÖÏóêÏÑú Ï†úÎ™©Í≥º ÏΩîÎ©òÌä∏ ÏûÖÎ†• ÌõÑ Ï†ÄÏû•Ìï† Îïå Ïã§Ìñâ
                form.onsubmit = function (event) {
                    event.preventDefault();

                    const title = document.getElementById('title').value;
                    const comment = document.getElementById('comment').value;

                    annotation["name"] = title;
                    annotation["description"] = comment;

                    {% if can_create_annotation %}
                        updateAnnotationDisplay(annotation);
                    {% endif %}

                    closePopup();

                    resolve(annotation);
                };
            });
        }

        // ÌåùÏóÖÏùÑ Îã´Îäî Ìï®Ïàò
        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('annotation-popup').style.display = 'none';
        }

        function cancelPopup() {
            if (!editMode) {
                activeAnno.removeAnnotation(activeAnno.getSelected()[0]);
            }
            closePopup();
        }

        function updateAnnotationDisplay(annotation) {
            // article-bodyÏóê Ï£ºÏÑùÏùò ÏÑ§Î™ÖÍ≥º Ïù¥Î¶ÑÏùÑ Ìïú Î¨∏Îã®ÏúºÎ°ú Ï∂îÍ∞Ä
            const articleBody = document.getElementById('article-body');
            const combinedElement = document.createElement('p');
            combinedElement.id = 'annotation-combined-' + annotation.id;

            // ÏÑ§Î™Ö Î∂ÄÎ∂Ñ
            const descriptionSpan = document.createElement('span');
            descriptionSpan.classList.add('annotation-description');
            descriptionSpan.style.color = 'black';
            const formattedDescription = annotation["description"].replace(/\n/g, '<br>');
            descriptionSpan.innerHTML = formattedDescription;

            // Íµ¨Î∂ÑÏûê
            const separator = document.createTextNode(': ');

            // Ïù¥Î¶Ñ Î∂ÄÎ∂Ñ
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('annotation-name');
            nameSpan.style.color = 'blue';
            const formattedName = annotation["name"].replace(/\n/g, '<br>');
            nameSpan.innerHTML = formattedName;

            // ÏöîÏÜåÎì§ÏùÑ Ï°∞Ìï©ÌïòÏó¨ ÌïòÎÇòÏùò Î¨∏Îã®Ïóê Ï∂îÍ∞Ä
            combinedElement.appendChild(nameSpan);
            combinedElement.appendChild(separator);
            combinedElement.appendChild(descriptionSpan);

            articleBody.appendChild(combinedElement);

            // ÌÅ¥Î¶≠ Ïãú Ï£ºÏÑù ÏòÅÏó≠ÏúºÎ°ú Ïù¥Îèô (combinedElement Ï†ÑÏ≤¥Ïóê Ïù¥Î≤§Ìä∏ Ï†ÅÏö©)
            combinedElement.addEventListener('click', function () {
                anno.fitBounds(annotation, {immediately: false, padding: 50});
            });
        }


        // Ï£ºÏÑù ÏàòÏ†ï Ìï®Ïàò
        function openEditPopup(annotation) {
            editMode = true;
            // Í∏∞Ï°¥ Í∞íÏúºÎ°ú ÏûÖÎ†• ÌïÑÎìú ÎØ∏Î¶¨ Ï±ÑÏö∞Í∏∞
            document.getElementById('title').value = annotation["name"] || '';
            document.getElementById('comment').value = annotation["description"] || '';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('annotation-popup').style.display = 'block';

            const form = document.getElementById('annotation-form');

            form.onsubmit = function (event) {
                event.preventDefault();

                const newTitle = document.getElementById('title').value;
                const newComment = document.getElementById('comment').value;

                // ÏàòÏ†ïÎêú ÎÇ¥Ïö©ÏúºÎ°ú annotation ÏóÖÎç∞Ïù¥Ìä∏
                annotation["name"] = newTitle;
                annotation["description"] = newComment;


                activeAnno.updateAnnotation(annotation);

                {% if can_create_annotation %}
                    let bodyElem = document.getElementById('annotation-combined-' + annotation.id);
                    if (bodyElem) bodyElem.remove();
                    updateAnnotationDisplay(annotation);
                {% endif %}

                closePopup();
            };
        }

        // Ï£ºÏÑù Ïà®Í∏∞Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        document.getElementById('invisible-btn').addEventListener('click', function () {
            const icon = this.querySelector('i');
            // ÌòÑÏû¨ ÏïÑÏù¥ÏΩòÏù¥ eye-slashÏù¥Î©¥ Î≥¥Ïù¥Îäî ÏÉÅÌÉú => Ïà®Í∏∞Í∏∞
            if (icon.classList.contains('bi-eye-slash')) {
                activeAnno.cancelSelected();
                activeAnno.setVisible(false); // Ï£ºÏÑù Ïà®Í∏∞Í∏∞
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
                this.title = "Show Annotation";

                plugin.deselectMeasurement();
                plugin.measurements.forEach(m => {
                    if (m.line) m.line.visible = false;
                    if (m.textObject) m.textObject.visible = false;
                    if (m.p1?.fabricObject) m.p1.fabricObject.visible = false;
                    if (m.p2?.fabricObject) m.p2.fabricObject.visible = false;
                });
                plugin.fabricCanvas.renderAll();

            } else {
                // ÌòÑÏû¨ ÏïÑÏù¥ÏΩòÏù¥ eyeÏù¥Î©¥ Ïïà Î≥¥Ïù¥Îäî ÏÉÅÌÉú => Î≥¥Ïù¥Í∏∞
                activeAnno.setVisible(true); // Ï£ºÏÑù Î≥¥Ïù¥Í∏∞
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
                this.title = "Hide Annotation";

                plugin.measurements.forEach(m => {
                    if (m.line) m.line.visible = true;
                    if (m.textObject) m.textObject.visible = true;
                    if (m.p1?.fabricObject) m.p1.fabricObject.visible = true;
                    if (m.p2?.fabricObject) m.p2.fabricObject.visible = true;
                });
                plugin.fabricCanvas.renderAll();

            }
        });


        //Information popup Ï∂îÍ∞Ä
        // infoÌåùÏóÖÏùÑ Ïó¥Í∏∞ ÏúÑÌïú Ìï®Ïàò
        function openinfoPopup() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById("information-popup").style.display = "block";
        }

        // infoÌåùÏóÖ Îã´Í∏∞
        function closeinfoPopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById("information-popup").style.display = "none";
        }


        // CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò (Django CSRF Î≥¥Ìò∏)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');



        // Function to update filters based on slider values
        function updateFilters() {
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const saturate = document.getElementById('saturate').value;

            // Update the displayed values
            document.getElementById('brightness-value').textContent = Math.round((parseFloat(brightness) * 100 - 100));
            document.getElementById('contrast-value').textContent = Math.round((parseFloat(contrast) * 100 - 100));
            document.getElementById('saturate-value').textContent = Math.round((parseFloat(saturate) * 100 - 100));

            // Apply CSS filters to the OpenSeadragon viewer
            document.querySelector('#openseadragon-container canvas').style.filter = `brightness(${brightness}) contrast(${contrast}) saturate(${saturate})`;
        }

        // Function to reset brightness to default
        function resetBrightness() {
            const brightnessSlider = document.getElementById('brightness');
            brightnessSlider.value = 1;
            updateFilters();
        }

        // Function to reset contrast to default
        function resetContrast() {
            const contrastSlider = document.getElementById('contrast');
            contrastSlider.value = 1;
            updateFilters();
        }

        function resetSaturate() {
            const saturateSlider = document.getElementById('saturate');
            saturateSlider.value = 1;
            updateFilters();
        }

        // Initialize filters on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateFilters();
        });

        function captureOpenSeadragonView() {
            const viewerElement = viewer.element;
            const canvas = document.querySelector('#openseadragon-container > div > div.openseadragon-canvas > canvas:nth-child(1)');
            const filterValue = canvas.style.filter || 'none';
            const ctx = canvas.getContext('2d');
          
            const originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.filter = filterValue;
            tempCtx.drawImage(canvas, 0, 0);
          
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(tempCanvas, 0, 0);
          
            viewer.setMouseNavEnabled(false);
            viewer.setControlsEnabled(false);
          
            html2canvas(viewerElement, {
              useCORS: true,
              backgroundColor: null,
              scale: 2
            }).then(originalCanvas => {
              const filename = typeof getScreenshotFilename === 'function'
                ? getScreenshotFilename()
                : 'screenshot';
              
              const now = new Date();
              const dateString = now.toLocaleDateString('ko-KR'); // Ïòà: 2025. 5. 12.
              const timeString = now.toLocaleTimeString('ko-KR'); // Ïòà: 14:23:45
              const dateTimeString = `${dateString.replace(/\./g, '-').replace(/\s/g, '')} ${timeString}`;
          
              // üí° Ïó¨Î∞± Ï∂îÍ∞ÄÌï† Ï∫îÎ≤ÑÏä§ ÎßåÎì§Í∏∞
              const marginHeight = 50; // ÏïÑÎûò Ïó¨Î∞± ÌÅ¨Í∏∞ (px)
              const finalCanvas = document.createElement('canvas');
              finalCanvas.width = originalCanvas.width;
              finalCanvas.height = originalCanvas.height + marginHeight;
          
              const finalCtx = finalCanvas.getContext('2d');
          
              // Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
              finalCtx.drawImage(originalCanvas, 0, 0);
          
              // ÏïÑÎûò Ïó¨Î∞± Ìù∞ÏÉâ Î∞∞Í≤Ω
              finalCtx.fillStyle = 'white';
              finalCtx.fillRect(0, originalCanvas.height, finalCanvas.width, marginHeight);
          
              // ÌÖçÏä§Ìä∏ ÏûëÏÑ±
              finalCtx.fillStyle = 'black';
              finalCtx.font = '36px arial';
              finalCtx.textBaseline = 'top';
              const username = "{{ user.username }}";
              const slideTitle = "{{ slide.name|slice:':30' }}".replace(/\s+/g, '_');

              finalCtx.textAlign = 'left';
              finalCtx.fillText(`${slideTitle}`, 10, originalCanvas.height + 5);
              finalCtx.textAlign = 'center';
              finalCtx.fillText(`Î∞∞Ïú®: ${Math.round(currentMagnification)}X`, finalCanvas.width / 2, originalCanvas.height + 5);
              finalCtx.textAlign = 'right';
              finalCtx.fillText(`${username} | ${dateTimeString}`, finalCanvas.width - 10, originalCanvas.height + 5);
          
              // Ï†ÄÏû•
              finalCanvas.toBlob(blob => {
                saveAs(blob, `${filename}.png`);

                const item = new ClipboardItem({ 'image/png': blob });
            
                navigator.clipboard.write([item]).then(() => {
                    alert('Ïù¥ÎØ∏ÏßÄÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§! Ctrl+VÎ°ú Î∂ôÏó¨ÎÑ£Ïñ¥Î≥¥ÏÑ∏Ïöî.');
                }).catch(err => {
                    console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', err);
                });
              });
          
              // Î≥µÏõê
              ctx.putImageData(originalImageData, 0, 0);
              viewer.setMouseNavEnabled(true);
              viewer.setControlsEnabled(true);
            }).catch(err => {
              console.error('‚ùå Ï∫°Ï≤ò Ïã§Ìå®:', err);
              ctx.putImageData(originalImageData, 0, 0);
              viewer.setMouseNavEnabled(true);
              viewer.setControlsEnabled(true);
            });
          }
          
    </script>
    <script src="{% static 'slide_viewer/js/viewer.js' %}" type="text/javascript"></script>
{% endblock extra_js %}